<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Magisk Module</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&family=JetBrains+Mono:wght@400;700&display=stylesheet">
    <style>
        body {
            font-family: 'Exo 2', sans-serif;
            background: linear-gradient(135deg, #0a1320 0%, #1a2c3a 100%) fixed;
            color: #d4f1f9;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .bg-particles {
            position: absolute;
            inset: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><circle cx="50" cy="50" r="2" fill="#26a69a"/><circle cx="750" cy="750" r="3" fill="#5e35b1"/></svg>') repeat;
            opacity: 0.15;
            z-index: 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 18px;
            flex-shrink: 0;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #374151;
            transition: background-color 0.3s;
            border-radius: 18px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: #d4f1f9;
            transition: transform 0.3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #26a69a;
        }
        input:checked + .slider:before {
            transform: translateX(18px);
        }
        input:disabled + .slider {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .modal, .confirmation-modal, .cmd-output-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow: auto;
        }
        .modal-content, .confirmation-content, .cmd-output-content {
            background: #0a1320;
            border: 1px solid #5e35b1;
            border-radius: 8px;
            padding: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
            position: relative;
        }
        .confirmation-content {
            max-width: 300px;
            text-align: center;
        }

        .notification {
            display: none;
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #26a69a;
            color: #0a1320;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1001;
            max-width: 90%;
            word-wrap: break-word;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(to right, #26a69a, #5e35b1);
            border-radius: 4px;
            transition: width 0.3s ease-in-out;
            width: 100%;
        }

        .cmd-output {
            background: #0a1320;
            padding: 12px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            border: 1px solid #26a69a;
            box-sizing: border-box;
            color: #d4f1f9;
            line-height: 1.5;
            max-height: 50vh;
        }

        .ansi-green { color: #26a69a; }
        .ansi-red { color: #ef5350; }
        .ansi-cyan { color: #00acc1; }
        .ansi-yellow { color: #ffca28; }

        .dropdown-content {
            display: none;
            margin-top: 8px;
        }
        .dropdown-content.show {
            display: block;
        }

        #sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #sidebar.open {
            transform: translateX(0);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0a1320;
            border-top: 1px solid #5e35b1;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            z-index: 20;
            margin-top: 20px;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: #d4f1f9;
            transition: background-color 0.3s;
        }
        .nav-item.active {
            background: #26a69a;
            color: #0a1320;
        }
        .nav-item:hover {
            background: #374151;
        }

        .tab-content {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
            opacity: 1;
        }

        .module-text-container {
            flex-grow: 1;
            flex-shrink: 1;
            min-width: 0;
            overflow: hidden;
        }
        .module-text-container p {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 640px) {
            .modal-content, .confirmation-content, .cmd-output-content {
                width: 95%;
                max-width: 95%;
                padding: 12px;
            }
            .cmd-output {
                font-size: 11px;
                max-height: 40vh;
            }
            .notification {
                font-size: 12px;
                padding: 6px 12px;
            }
            .bottom-nav {
                height: 50px;
            }
            .nav-item {
                padding: 8px;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div class="bg-particles"></div>
    <div class="container mx-auto max-w-4xl relative z-10">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <button id="sidebar-toggle" class="text-teal-400 hover:text-teal-300 sm:mr-4">
                <i class="fas fa-bars text-lg"></i>
            </button>
            <h1 class="text-2xl sm:text-3xl font-bold text-teal-300">Neon Magisk Module Dashboard</h1>
            <div class="flex items-center mt-4 sm:mt-0">
                <div id="shizuku-status" class="flex items-center gap-2 px-3 py-1 bg-gray-800/50 border border-teal-500 округлый-full text-sm">
                    <i class="fas fa-circle-notch fa-spin" style="color: #6b7280;"></i>
                    <span>Checking Shizuku...</span>
                </div>
            </div>
        </div>

        <!-- Home Tab Content -->
        <div id="home-content" class="tab-content active">
            <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-center cursor-pointer" id="device-info-toggle">
                    <h2 class="text-lg font-bold text-teal-300">Device Info</h2>
                    <div>
                        <button id="refresh-device-info" class="text-teal-400 hover:text-teal-300 mr-2">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <i class="fas fa-chevron-down text-teal-400"></i>
                    </div>
                </div>
                <div id="device-info" class="dropdown-content text-gray-300"></div>
            </div>
            <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
                <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-cog mr-2"></i>Custom Module</h2>
                <div id="custom-module-list">
                    <div class="flex justify-between items-center bg-gray-800/50 border-l-4 border-purple-600 p-3 rounded-lg mb-2">
                        <span class="flex items-center gap-2">
                            <i class="fas fa-cog text-teal-400"></i>
                            <span>Using Custom Module</span>
                        </span>
                        <div>
                            <input type="file" id="custom-module-input" accept=".sh" class="hidden">
                            <button id="custom-module-btn" class="px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400">Select</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
                <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-mobile-alt mr-2"></i>Fake Device Modules</h2>
                <div id="fake-device-items"></div>
                <button id="restore-device-btn" class="w-full mt-2 px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400">Restore Device</button>
            </div>
            <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
                <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-tachometer-alt mr-2"></i>FPS Modules</h2>
                <div id="fps-module-items"></div>
            </div>
            <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-history mr-2"></i>Command Log</h2>
                    <button id="clear-logs-btn" class="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-400">Clear All Logs</button>
                </div>
                <div id="log-list"></div>
            </div>
        </div>

        <!-- Performance Tab Content -->
        <div id="performance-content" class="tab-content">
            <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
                <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-bolt mr-2"></i>Performance Modules</h2>
                <div id="module-items"></div>
            </div>
            <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-history mr-2"></i>Command Log</h2>
                    <button id="clear-logs-btn-performance" class="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-400">Clear All Logs</button>
                </div>
                <div id="log-list"></div>
            </div>
        </div>

        <!-- Game Tab Content -->
        <div id="game-content" class="tab-content">
            <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
                <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-gamepad mr-2"></i>Game Optimization</h2>
                <div id="game-items"></div>
            </div>
            <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-history mr-2"></i>Command Log</h2>
                    <button id="clear-logs-btn-game" class="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-400">Clear All Logs</button>
                </div>
                <div id="log-list"></div>
            </div>
        </div>
    </div>

    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-900/90 border-r border-teal-500 transform -translate-x-full transition-transform duration-300 z-20">
        <div class="p-4">
            <button id="sidebar-close" class="text-teal-400 hover:text-teal-300 mb-4">
                <i class="fas fa-times text-lg"></i>
            </button>
            <h2 class="text-lg font-bold text-teal-300 mb-4"><i class="fas fa-bars mr-2"></i>Menu</h2>
            <ul class="space-y-3">
                <li><a href="#" class="flex items-center gap-2 text-teal-400 hover:text-teal-300"><i class="fas fa-info-circle"></i><span id="app-version">Version: Loading...</span></a></li>
                <li><a href="#" class="flex items-center gap-2 text-teal-400 hover:text-teal-300"><i class="fas fa-star"></i><span>Rating: 4.5/5</span></a></li>
                <li><a href="#" class="flex items-center gap-2 text-teal-400 hover:text-teal-300"><i class="fas fa-user"></i><span>Credit: Agung Developer</span></a></li>
                <li><a href="https://link.dana.id/minta?full_url=https://qr.dana.id/v1/281012092025071835695915" class="flex items-center gap-2 text-teal-400 hover:text-teal-300" target="_blank"><i class="fas fa-donate"></i><span>Donate</span></a></li>
            </ul>
        </div>
        <div class="p-4 border-t border-gray-700 text-center">
            <h3 class="text-md font-semibold text-teal-300 mb-2"><i class="fas fa-share-alt mr-2"></i>Follow Us</h3>
            <div class="flex justify-center gap-4 text-teal-400">
                <a href="https://youtube.com/@neoninjectofficial?si=2JZi-XH7MyGX9xBX" class="hover:text-teal-300 text-xl" target="_blank"><i class="fab fa-youtube"></i></a>
                <a href="https://www.tiktok.com/@neoninject?_t=ZS-8y7bsj0p15I&_r=1" class="hover:text-teal-300 text-xl" target="_blank"><i class="fab fa-tiktok"></i></a>
                <a href="https://www.instagram.com/agungeka_22?igsh=dmo4YnR4dTF3cnhq" class="hover:text-teal-300 text-xl" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://agungwandev.com" class="hover:text-teal-300 text-xl" target="_blank"><i class="fas fa-globe"></i></a>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" data-tab="home-content">
            <i class="fas fa-home text-lg"></i>
        </div>
        <div class="nav-item" data-tab="performance-content">
            <i class="fas fa-bolt text-lg"></i>
        </div>
        <div class="nav-item" data-tab="game-content">
            <i class="fas fa-gamepad text-lg"></i>
        </div>
    </div>

    <div id="download-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" class="text-base font-bold text-teal-300 mb-2"><i class="fas fa-download mr-2"></i>Processing...</h2>
            <div class="progress-bar" id="modal-progress" style="width: 0%"></div>
            <p id="modal-status" class="mt-2 text-gray-300 text-xs"></p>
        </div>
    </div>

    <div id="cmd-output-modal" class="cmd-output-modal">
        <div class="cmd-output-content">
            <h2 class="text-base font-bold text-teal-300 mb-2"><i class="fas fa-terminal mr-2"></i>Command Output</h2>
            <pre id="cmd-output" class="cmd-output"></pre>
            <button class="px-3 py-1 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400 mt-2 w-full" onclick="document.getElementById('cmd-output-modal').style.display='none'">Close</button>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <div id="confirmation-modal" class="confirmation-modal">
        <div class="confirmation-content">
            <p id="confirmation-message" class="text-sm text-teal-200 mb-3"></p>
            <div class="flex justify-center gap-2">
                <button id="confirm-yes" class="px-3 py-1 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400">Yes</button>
                <button id="confirm-no" class="px-3 py-1 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-500">No</button>
            </div>
        </div>
    </div>

    <script>
        let confirmResolver;

        function showConfirmation(message) {
            const modal = document.getElementById("confirmation-modal");
            document.getElementById("confirmation-message").textContent = message;
            modal.style.display = "flex";
            return new Promise(resolve => { confirmResolver = resolve; });
        }

        document.getElementById("confirm-yes").addEventListener("click", () => {
            document.getElementById("confirmation-modal").style.display = "none";
            if (confirmResolver) confirmResolver(true);
        });

        document.getElementById("confirm-no").addEventListener("click", () => {
            document.getElementById("confirmation-modal").style.display = "none";
            if (confirmResolver) confirmResolver(false);
        });

        function showNotification(message, duration = 3000) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.style.display = "block";
            setTimeout(() => { notification.style.display = "none"; }, duration);
        }

        function generateRandomId() {
            const characters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            return Array(15).fill().map(() => characters.charAt(Math.floor(Math.random() * characters.length))).join('');
        }

        function parseAnsiColors(text) {
            const ansiMap = {
                '\x1B[0;31m': '<span class="ansi-red">',
                '\x1B[0;32m': '<span class="ansi-green">',
                '\x1B[0;36m': '<span class="ansi-cyan">',
                '\x1B[1;33m': '<span class="ansi-yellow">',
                '\x1B[0m': '</span>'
            };
            let result = text.replace(/[&<>"']/g, m => ({ '&': '&', '<': '<', '>': '>', '"': '"', "'": '\'' })[m]);
            for (const [ansi, html] of Object.entries(ansiMap)) {
                result = result.replace(new RegExp(ansi.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&'), 'g'), html);
            }
            return result;
        }

        const MODULES_URL = "https://raw.githubusercontent.com/AgungDevlop/Neon-Modules/refs/heads/main/Modules.json";
        const FPS_MODULES_URL = "https://raw.githubusercontent.com/AgungDevlop/Viral/refs/heads/main/FpsSetting.json";
        const FAKE_DEVICE_URL = "https://raw.githubusercontent.com/AgungDevlop/Viral/main/FakeDevice.json";
        const GAME_URL = "https://raw.githubusercontent.com/AgungDevlop/Neon-Modules/refs/heads/main/Game.json";
        const RESTORE_DEVICE_URL = "https://raw.githubusercontent.com/AgungDevlop/Neon-Modules/main/restoredevice.sh";
        const downloadedModules = new Set(JSON.parse(localStorage.getItem("downloadedModules") || "[]"));
        const activeModules = new Set(JSON.parse(localStorage.getItem("activeModules") || "[]"));
        const activeFakeDevices = new Set(JSON.parse(localStorage.getItem("activeFakeDevices") || "[]"));
        const selectedGames = new Set(JSON.parse(localStorage.getItem("selectedGames") || "[]"));
        let commandLogs = JSON.parse(localStorage.getItem("commandLogs") || "[]");

        async function loadAppVersion() {
            try {
                const version = window.Android?.getAppVersion ? await window.Android.getAppVersion() : "N/A (WebView)";
                document.getElementById("app-version").textContent = `Version: ${version || 'Unknown'}`;
            } catch (e) {
                console.error("Error loading app version:", e);
                document.getElementById("app-version").textContent = "Version: Error";
            }
        }

        async function checkShizukuStatus() {
            try {
                const status = window.Android?.getShizukuStatus ? await window.Android.getShizukuStatus() : false;
                document.getElementById("shizuku-status").innerHTML = `
                    <i class="fas ${status ? 'fa-check-circle' : 'fa-times-circle'}" style="color: ${status ? '#26a69a' : '#ef5350'};"></i>
                    <span>Shizuku: ${status ? 'Running' : 'Not Running'}</span>`;
                return status;
            } catch (e) {
                console.error("Error checking Shizuku status:", e);
                document.getElementById("shizuku-status").innerHTML = `
                    <i class="fas fa-exclamation-circle" style="color: #ef5350;"></i>
                    <span>Shizuku: Error</span>`;
                return false;
            }
        }

        async function loadDeviceInfo() {
            try {
                if (window.Android?.getDeviceInfo) {
                    const info = await window.Android.getDeviceInfo();
                    const deviceInfo = JSON.parse(info);
                    document.getElementById("device-info").innerHTML = `
                        <p class="text-sm"><strong>Device:</strong> ${deviceInfo.brand || 'Unknown'} ${deviceInfo.model || 'Unknown'}</p>
                        <p class="text-sm"><strong>CPU:</strong> ${deviceInfo.cpu || 'Unknown'}</p>
                        <p class="text-sm"><strong>SDK:</strong> ${deviceInfo.sdk || 'Unknown'}</p>
                        <p class="text-sm"><strong>Build:</strong> ${deviceInfo.build || 'Unknown'}</p>
                        <p class="text-sm"><strong>Root:</strong> ${deviceInfo.root || 'Unknown'}</p>
                    `;
                } else {
                    document.getElementById("device-info").innerHTML = `<p class="text-gray-300 text-sm"><i class="fas fa-info-circle mr-2"></i>Device info not available.</p>`;
                }
            } catch (e) {
                console.error("Error loading device info:", e);
                document.getElementById("device-info").innerHTML = `<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>Failed to load device info.</p>`;
            }
        }

        async function checkModuleExists(moduleName) {
            try {
                if (window.Android?.checkFileExists) {
                    const fileName = moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
                    const exists = await window.Android.checkFileExists(`/storage/emulated/0/Download/com.neon.magisk.module/${fileName}`);
                    if (exists && !downloadedModules.has(moduleName)) {
                        downloadedModules.add(moduleName);
                        localStorage.setItem("downloadedModules", JSON.stringify([...downloadedModules]));
                    } else if (!exists && downloadedModules.has(moduleName)) {
                        downloadedModules.delete(moduleName);
                        localStorage.setItem("downloadedModules", JSON.stringify([...downloadedModules]));
                    }
                    return exists;
                }
                return false;
            } catch (e) {
                console.error("Error checking file existence:", e);
                return false;
            }
        }

        let allModules = [];
        let allFpsModules = [];
        let allFakeDevices = [];
        let allGames = [];
        async function loadModules() {
            try {
                if (!allModules.length) {
                    let modules = JSON.parse(localStorage.getItem("cachedModules"));
                    if (!modules) {
                        const response = await fetch(MODULES_URL, { cache: "no-store" });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        modules = await response.json();
                        localStorage.setItem("cachedModules", JSON.stringify(modules));
                    }
                    allModules = modules;
                }
                for (const module of allModules) await checkModuleExists(module.name);
                renderModules(allModules);
            } catch (error) {
                console.error("Error loading performance modules:", error);
                document.getElementById("module-items").innerHTML = '<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>Failed to load performance modules. Check your internet connection.</p>';
            }
        }

        async function loadFpsModules() {
            try {
                if (!allFpsModules.length) {
                    let fpsModules = JSON.parse(localStorage.getItem("cachedFpsModules"));
                    if (!fpsModules) {
                        const response = await fetch(FPS_MODULES_URL, { cache: "no-store" });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        fpsModules = await response.json();
                        localStorage.setItem("cachedFpsModules", JSON.stringify(fpsModules));
                    }
                    allFpsModules = fpsModules;
                }
                for (const module of allFpsModules) await checkModuleExists(module.name);
                renderFpsModules(allFpsModules);
            } catch (error) {
                console.error("Error loading FPS modules:", error);
                document.getElementById("fps-module-items").innerHTML = '<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>Failed to load FPS modules. Check your internet connection.</p>';
            }
        }

        async function loadFakeDevices() {
            try {
                if (!allFakeDevices.length) {
                    let fakeDevices = JSON.parse(localStorage.getItem("cachedFakeDevices"));
                    if (!fakeDevices) {
                        const response = await fetch(FAKE_DEVICE_URL, { cache: "no-store" });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        fakeDevices = await response.json();
                        localStorage.setItem("cachedFakeDevices", JSON.stringify(fakeDevices));
                    }
                    allFakeDevices = fakeDevices;
                }
                for (const device of allFakeDevices) await checkModuleExists(device.name);
                renderFakeDevices(allFakeDevices);
            } catch (error) {
                console.error("Error loading fake device modules:", error);
                document.getElementById("fake-device-items").innerHTML = '<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>Failed to load fake device modules. Check your internet connection.</p>';
            }
        }

        async function loadGames() {
            try {
                if (!allGames.length) {
                    let games = JSON.parse(localStorage.getItem("cachedGames"));
                    if (!games) {
                        const response = await fetch(GAME_URL, { cache: "no-store" });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        games = await response.json();
                        localStorage.setItem("cachedGames", JSON.stringify(games));
                    }
                    allGames = games;
                }
                renderGames(allGames);
            } catch (error) {
                console.error("Error loading games:", error);
                document.getElementById("game-items").innerHTML = '<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>Failed to load games. Check your internet connection.</p>';
            }
        }

        function renderModules(modules) {
            const moduleList = document.getElementById("module-items");
            moduleList.innerHTML = "";
            const stopModule = modules.find(module => module.name === "STOP MODULE");
            const otherModules = modules.filter(module => module.name !== "STOP MODULE");
            const sortedModules = stopModule ? [stopModule, ...otherModules] : otherModules;
            sortedModules.forEach((module, index) => {
                const isActive = activeModules.has(module.name);
                const isDownloaded = downloadedModules.has(module.name);
                const moduleItem = document.createElement("div");
                moduleItem.className = "bg-gray-800/50 border-l-4 border-purple-600 p-2 rounded-lg mb-1";
                if (index === 0 && module.name === "STOP MODULE") {
                    moduleItem.innerHTML = `
                        <button id="btn-remove-modules" 
                                class="w-full px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400"
                                onclick="handleModuleAction('STOP MODULE', '${module.url}')">
                            Remove Modules
                        </button>
                    `;
                } else {
                    moduleItem.className += " flex justify-between items-center";
                    moduleItem.innerHTML = `
                        <div class="module-text-container flex-grow flex flex-col">
                            <span class="flex items-center gap-2 text-sm">
                                <i class="fas fa-microchip text-teal-400 text-sm"></i>
                                <span>${module.name}</span>
                            </span>
                            <p class="text-[10px] text-gray-300">${module.desc}</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="switch-${module.name.replace(/[^a-zA-Z0-9]/g, '')}" ${isActive ? 'checked' : ''} ${module.name === "STOP MODULE" ? 'disabled' : ''}>
                            <span class="slider"></span>
                        </label>
                    `;
                    const switchElement = moduleItem.querySelector(`#switch-${module.name.replace(/[^a-zA-Z0-9]/g, '')}`);
                    if (switchElement) {
                        switchElement.addEventListener("change", async (e) => {
                            if (e.target.checked) {
                                const shizukuRunning = await checkShizukuStatus();
                                if (!shizukuRunning) {
                                    showNotification("Shizuku is not running. Please start Shizuku and try again.");
                                    e.target.checked = false;
                                    return;
                                }
                                await handleModuleAction(module.name, module.url);
                            } else {
                                if (await showConfirmation(`Are you sure you want to disable ${module.name}?`)) {
                                    activeModules.delete(module.name);
                                    localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                                    renderModules(allModules);
                                } else {
                                    e.target.checked = true;
                                }
                            }
                        });
                    }
                }
                moduleList.appendChild(moduleItem);
            });
            if (stopModule && stopModule.name === "STOP MODULE") {
                const removeModulesBtn = document.getElementById("btn-remove-modules");
                if (removeModulesBtn) {
                    removeModulesBtn.addEventListener("click", async () => {
                        const shizukuRunning = await checkShizukuStatus();
                        if (!shizukuRunning) {
                            showNotification("Shizuku is not running. Please start Shizuku and try again.");
                            return;
                        }
                        await handleModuleAction("STOP MODULE", stopModule.url);
                        // Disable all switches in the performance tab
                        const switches = document.querySelectorAll('#module-items .switch input');
                        switches.forEach(switchElement => {
                            switchElement.checked = false;
                            switchElement.disabled = true;
                        });
                        // Clear active modules
                        activeModules.clear();
                        localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                        showNotification("All performance modules have been disabled.");
                    });
                }
            }
        }

        function renderFpsModules(modules) {
            const fpsModuleList = document.getElementById("fps-module-items");
            fpsModuleList.innerHTML = "";
            const stopModule = modules.find(module => module.name === "Stop Module");
            const otherModules = modules.filter(module => module.name !== "Stop Module");
            const sortedModules = stopModule ? [stopModule, ...otherModules] : otherModules;
            sortedModules.forEach((module, index) => {
                const isActive = activeModules.has(module.name);
                const isDownloaded = downloadedModules.has(module.name);
                const moduleItem = document.createElement("div");
                moduleItem.className = "bg-gray-800/50 border-l-4 border-purple-600 p-2 rounded-lg mb-1";
                if (index === 0 && module.name === "Stop Module") {
                    moduleItem.innerHTML = `
                        <button id="btn-remove-fps-modules" 
                                class="w-full px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400"
                                onclick="handleModuleAction('Stop Module', '${module.url}')">
                            Remove FPS Modules
                        </button>
                    `;
                } else {
                    moduleItem.className += " flex justify-between items-center";
                    moduleItem.innerHTML = `
                        <div class="module-text-container flex-grow flex flex-col">
                            <span class="flex items-center gap-2 text-sm">
                                <i class="fas fa-tachometer-alt text-teal-400 text-sm"></i>
                                <span>${module.name}</span>
                            </span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="fps-switch-${module.name.replace(/[^a-zA-Z0-9]/g, '')}" ${isActive ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    `;
                    const switchElement = moduleItem.querySelector(`#fps-switch-${module.name.replace(/[^a-zA-Z0-9]/g, '')}`);
                    if (switchElement) {
                        switchElement.addEventListener("change", async (e) => {
                            if (e.target.checked) {
                                const shizukuRunning = await checkShizukuStatus();
                                if (!shizukuRunning) {
                                    showNotification("Shizuku is not running. Please start Shizuku and try again.");
                                    e.target.checked = false;
                                    return;
                                }
                                await handleModuleAction(module.name, module.url);
                            } else {
                                if (await showConfirmation(`Are you sure you want to disable ${module.name}?`)) {
                                    activeModules.delete(module.name);
                                    localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                                    renderFpsModules(allFpsModules);
                                } else {
                                    e.target.checked = true;
                                }
                            }
                        });
                    }
                }
                fpsModuleList.appendChild(moduleItem);
            });
        }

        function renderFakeDevices(fakeDevices) {
            const fakeDeviceList = document.getElementById("fake-device-items");
            fakeDeviceList.innerHTML = "";
            fakeDevices.forEach(device => {
                if (device.name === "Restore Device") return;
                const isActive = activeFakeDevices.has(device.name);
                const isDownloaded = downloadedModules.has(device.name);
                const deviceItem = document.createElement("div");
                deviceItem.className = "bg-gray-800/50 border-l-4 border-purple-600 p-2 rounded-lg mb-1 flex justify-between items-center";
                deviceItem.innerHTML = `
                    <div class="module-text-container flex-grow flex flex-col">
                        <span class="flex items-center gap-2 text-sm">
                            <i class="fas fa-mobile-alt text-teal-400 text-sm"></i>
                            <span>${device.name}</span>
                        </span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="fake-device-${device.name.replace(/[^a-zA-Z0-9]/g, '')}" ${isActive ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                `;
                fakeDeviceList.appendChild(deviceItem);
                const checkboxElement = document.getElementById(`fake-device-${device.name.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (checkboxElement) {
                    checkboxElement.addEventListener("change", async (e) => {
                        if (e.target.checked) {
                            if (activeFakeDevices.size > 0) {
                                showNotification("Only one fake device can be active at a time. Please disable the active fake device first.");
                                e.target.checked = false;
                                return;
                            }
                            const shizukuRunning = await checkShizukuStatus();
                            if (!shizukuRunning) {
                                showNotification("Shizuku is not running. Please start Shizuku and try again.");
                                e.target.checked = false;
                                return;
                            }
                            await handleFakeDeviceAction(device.name, device.url);
                        } else {
                            if (await showConfirmation(`Are you sure you want to disable ${device.name}?`)) {
                                activeFakeDevices.delete(device.name);
                                localStorage.setItem("activeFakeDevices", JSON.stringify([...activeFakeDevices]));
                                renderFakeDevices(allFakeDevices);
                                loadDeviceInfo();
                            } else {
                                e.target.checked = true;
                            }
                        }
                    });
                }
            });
        }

        function renderGames(games) {
            const gameList = document.getElementById("game-items");
            gameList.innerHTML = "";
            games.forEach(game => {
                const isSelected = selectedGames.has(game.game);
                const gameItem = document.createElement("div");
                gameItem.className = "bg-gray-800/50 border-l-4 border-purple-600 p-2 rounded-lg mb-1 flex justify-between items-center";
                gameItem.innerHTML = `
                    <div class="module-text-container flex-grow flex flex-col">
                        <span class="flex items-center gap-2 text-sm">
                            <i class="fas fa-gamepad text-teal-400 text-sm"></i>
                            <span>${game.game}</span>
                        </span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="game-${game.game.replace(/[^a-zA-Z0-9]/g, '')}" ${isSelected ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                `;
                gameList.appendChild(gameItem);
                const checkboxElement = document.getElementById(`game-${game.game.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (checkboxElement) {
                    checkboxElement.addEventListener("change", async (e) => {
                        if (e.target.checked) {
                            selectedGames.add(game.game);
                            localStorage.setItem("selectedGames", JSON.stringify([...selectedGames]));
                            const shizukuRunning = await checkShizukuStatus();
                            if (!shizukuRunning) {
                                showNotification("Shizuku is not running. Please start Shizuku and try again.");
                                e.target.checked = false;
                                selectedGames.delete(game.game);
                                localStorage.setItem("selectedGames", JSON.stringify([...selectedGames]));
                                return;
                            }
                            await handleGameAction(game.game, game.command);
                        } else {
                            if (await showConfirmation(`Are you sure you want to disable optimization for ${game.game}?`)) {
                                selectedGames.delete(game.game);
                                localStorage.setItem("selectedGames", JSON.stringify([...selectedGames]));
                            } else {
                                e.target.checked = true;
                            }
                        }
                    });
                }
            });
        }

        async function handleModuleAction(moduleName, moduleUrl) {
            if (activeModules.has(moduleName) && moduleName !== "STOP MODULE" && moduleName !== "Stop Module") {
                showNotification(`${moduleName} is already active.`);
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const fpsSwitchElement = document.getElementById(`fps-switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (switchElement) switchElement.checked = true;
                if (fpsSwitchElement) fpsSwitchElement.checked = true;
                return;
            }
            if (!window.Android) {
                showNotification("This feature is only available in the Android application.");
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const fpsSwitchElement = document.getElementById(`fps-switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (switchElement) switchElement.checked = false;
                if (fpsSwitchElement) fpsSwitchElement.checked = false;
                return;
            }
            const fileName = moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
            const modulePath = `/storage/emulated/0/Download/com.neon.magisk.module/${fileName}`;
            const logId = generateRandomId();
            window.currentLogId = logId;
            window.currentOutput = "";
            if (moduleName !== "STOP MODULE" && moduleName !== "Stop Module") {
                activeModules.add(moduleName);
                localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
            }
            if (!downloadedModules.has(moduleName)) {
                showDownloadModal(moduleName, moduleUrl);
            } else {
                try {
                    let runCommand = `sh ${modulePath}`;
                    if (selectedGames.size > 0 && moduleName !== "STOP MODULE" && moduleName !== "Stop Module") {
                        for (const game of allGames) {
                            if (selectedGames.has(game.game)) {
                                const packageName = game.command.match(/\+([a-zA-Z0-9.]+)/)?.[1] || '';
                                if (packageName) {
                                    runCommand += ` ${packageName}`;
                                }
                            }
                        }
                    }
                    await window.Android.executeCommand(runCommand, moduleName, logId);
                } catch (e) {
                    console.error("Error executing module:", e);
                    showNotification("Failed to run module. Ensure Shizuku is running and permissions are granted.");
                    if (moduleName !== "STOP MODULE" && moduleName !== "Stop Module") {
                        activeModules.delete(moduleName);
                        localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                    }
                    window.runComplete(moduleName, false, logId);
                    const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                    const fpsSwitchElement = document.getElementById(`fps-switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                    if (switchElement) switchElement.checked = false;
                    if (fpsSwitchElement) fpsSwitchElement.checked = false;
                }
            }
        }

        async function handleFakeDeviceAction(deviceName, deviceUrl) {
            if (activeFakeDevices.has(deviceName)) {
                showNotification(`${deviceName} is already active.`);
                const checkboxElement = document.getElementById(`fake-device-${deviceName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (checkboxElement) checkboxElement.checked = true;
                return;
            }
            if (!window.Android) {
                showNotification("This feature is only available in the Android application.");
                const checkboxElement = document.getElementById(`fake-device-${deviceName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (checkboxElement) checkboxElement.checked = false;
                return;
            }
            const fileName = deviceName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
            const devicePath = `/storage/emulated/0/Download/com.neon.magisk.module/${fileName}`;
            const logId = generateRandomId();
            window.currentLogId = logId;
            window.currentOutput = "";
            activeFakeDevices.add(deviceName);
            localStorage.setItem("activeFakeDevices", JSON.stringify([...activeFakeDevices]));
            if (!downloadedModules.has(deviceName)) {
                showDownloadModal(deviceName, deviceUrl);
            } else {
                try {
                    const runCommand = `sh ${devicePath}`;
                    await window.Android.executeCommand(runCommand, deviceName, logId);
                } catch (e) {
                    console.error("Error executing fake device module:", e);
                    showNotification("Failed to run fake device module. Ensure Shizuku is running and permissions are granted.");
                    activeFakeDevices.delete(deviceName);
                    localStorage.setItem("activeFakeDevices", JSON.stringify([...activeFakeDevices]));
                    window.runComplete(deviceName, false, logId);
                    const checkboxElement = document.getElementById(`fake-device-${deviceName.replace(/[^a-zA-Z0-9]/g, '')}`);
                    if (checkboxElement) checkboxElement.checked = false;
                }
            }
        }

        async function handleGameAction(gameName, gameCommand) {
            if (!window.Android) {
                showNotification("This feature is only available in the Android application.");
                const checkboxElement = document.getElementById(`game-${gameName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (checkboxElement) checkboxElement.checked = false;
                return;
            }
            const shizukuRunning = await checkShizukuStatus();
            if (!shizukuRunning) {
                showNotification("Shizuku is not running. Please start Shizuku and try again.");
                const checkboxElement = document.getElementById(`game-${gameName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (checkboxElement) checkboxElement.checked = false;
                return;
            }
            const logId = generateRandomId();
            window.currentLogId = logId;
            window.currentOutput = "";
            try {
                await window.Android.executeCommand(gameCommand, gameName, logId);
            } catch (e) {
                console.error("Error executing game command:", e);
                showNotification(`Failed to optimize ${gameName}. Ensure Shizuku is running and permissions are granted.`);
                selectedGames.delete(gameName);
                localStorage.setItem("selectedGames", JSON.stringify([...selectedGames]));
                window.runComplete(gameName, false, logId);
                const checkboxElement = document.getElementById(`game-${gameName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (checkboxElement) checkboxElement.checked = false;
            }
        }

        async function handleRestoreDevice() {
            if (!window.Android) {
                showNotification("This feature is only available in the Android application.");
                return;
            }
            const shizukuRunning = await checkShizukuStatus();
            if (!shizukuRunning) {
                showNotification("Shizuku is not running. Please start Shizuku and try again.");
                return;
            }
            const moduleName = "Restore Device";
            const fileName = "restoredevice.sh";
            const modulePath = `/storage/emulated/0/Download/com.neon.magisk.module/${fileName}`;
            const logId = generateRandomId();
            window.currentLogId = logId;
            window.currentOutput = "";
            if (!downloadedModules.has(moduleName)) {
                showDownloadModal(moduleName, RESTORE_DEVICE_URL);
            } else {
                try {
                    const runCommand = `sh ${modulePath}`;
                    await window.Android.executeCommand(runCommand, moduleName, logId);
                } catch (e) {
                    console.error("Error executing restore device module:", e);
                    showNotification("Failed to run restore device module. Ensure Shizuku is running and permissions are granted.");
                    window.runComplete(moduleName, false, logId);
                }
            }
        }

        async function handleCustomModule() {
            const fileInput = document.getElementById("custom-module-input");
            const file = fileInput.files[0];
            const button = document.getElementById("custom-module-btn");
            if (!file) {
                showNotification("Please select a file to run.");
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension !== 'sh') {
                showNotification("The selected file is not a .sh script. Please select a .sh file.");
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            if (!window.Android) {
                showNotification("This feature is only available in the Android application.");
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            const shizukuRunning = await checkShizukuStatus();
            if (!shizukuRunning) {
                showNotification("Shizuku is not running. Please start Shizuku and try again.");
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            const moduleName = file.name.replace(/\.sh$/, '');
            if (activeModules.has(moduleName)) {
                showNotification("This module is already active.");
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            const logId = generateRandomId();
            window.currentLogId = logId;
            window.currentOutput = "";
            activeModules.add(moduleName);
            localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const fileContent = e.target.result;
                    const fileName = moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
                    const filePath = `/storage/emulated/0/Download/com.neon.magisk.module/${fileName}`;
                    if (window.Android?.saveCustomModule) {
                        await window.Android.saveCustomModule(fileContent, filePath);
                        let runCommand = `sh ${filePath}`;
                        if (selectedGames.size > 0) {
                            for (const game of allGames) {
                                if (selectedGames.has(game.game)) {
                                    const packageName = game.command.match(/\+([a-zA-Z0-9.]+)/)?.[1] || '';
                                    if (packageName) {
                                        runCommand += ` ${packageName}`;
                                    }
                                }
                            }
                        }
                        try {
                            await window.Android.executeCommand(runCommand, moduleName, logId);
                        } catch (e) {
                            console.error("Error executing custom module:", e);
                            showNotification("Failed to run custom module. Ensure Shizuku is running and permissions are granted.");
                            activeModules.delete(moduleName);
                            localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                            window.runComplete(moduleName, false, logId);
                            fileInput.value = '';
                            button.textContent = "Select";
                            button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                        }
                    } else {
                        showNotification("Android file save functionality not available.");
                        activeModules.delete(moduleName);
                        localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                        window.runComplete(moduleName, false, logId);
                        fileInput.value = '';
                        button.textContent = "Select";
                        button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                    }
                };
                reader.readAsText(file);
            } catch (e) {
                console.error("Error processing custom module:", e);
                showNotification("Failed to process custom module.");
                activeModules.delete(moduleName);
                localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                window.runComplete(moduleName, false, logId);
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
            }
        }

        function showDownloadModal(moduleName, moduleUrl) {
            const modal = document.getElementById("download-modal");
            const progressBar = document.getElementById("modal-progress");
            const statusText = document.getElementById("modal-status");
            const title = document.getElementById("modal-title");
            title.innerHTML = `<i class="fas fa-download mr-2"></i>Downloading ${moduleName}`;
            statusText.textContent = "Starting download...";
            progressBar.style.width = "0%";
            modal.style.display = "flex";
            let currentProgress = 0;
            const progressInterval = setInterval(() => {
                currentProgress = Math.min(currentProgress + 5, 90);
                progressBar.style.width = `${currentProgress}%`;
                statusText.textContent = `Progress: ${currentProgress}%`;
            }, 300);
            window.downloadingModuleInterval = progressInterval;
            try {
                if (window.Android?.downloadFile) {
                    window.Android.downloadFile(moduleUrl, moduleName);
                } else {
                    showNotification("Download functionality not available in this environment.");
                    modal.style.display = "none";
                    clearInterval(window.downloadingModuleInterval);
                    window.runComplete(moduleName, false, window.currentLogId);
                    const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                    const fpsSwitchElement = document.getElementById(`fps-switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                    const checkboxElement = document.getElementById(`fake-device-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                    if (switchElement) switchElement.checked = false;
                    if (fpsSwitchElement) fpsSwitchElement.checked = false;
                    if (checkboxElement) checkboxElement.checked = false;
                }
            } catch (e) {
                console.error("Error initiating download:", e);
                showNotification("Failed to start download. Check your internet connection or Android interface.");
                modal.style.display = "none";
                clearInterval(window.downloadingModuleInterval);
                window.runComplete(moduleName, false, window.currentLogId);
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const fpsSwitchElement = document.getElementById(`fps-switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const checkboxElement = document.getElementById(`fake-device-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (switchElement) switchElement.checked = false;
                if (fpsSwitchElement) fpsSwitchElement.checked = false;
                if (checkboxElement) checkboxElement.checked = false;
            }
        }

        window.onShellOutput = function(moduleName, output, logId) {
            const cmdOutputModal = document.getElementById("cmd-output-modal");
            const cmdOutput = document.getElementById("cmd-output");
            window.currentOutput = (window.currentOutput || "") + output + "\n";
            cmdOutput.innerHTML = parseAnsiColors(window.currentOutput);
            cmdOutput.scrollTop = cmdOutput.scrollHeight;
            cmdOutputModal.style.display = "flex";
            if (window.Android?.saveLog) {
                window.Android.saveLog(window.currentOutput, logId);
            }
        };

        window.downloadComplete = function(moduleName, success) {
            const modal = document.getElementById("download-modal");
            const progressBar = document.getElementById("modal-progress");
            const statusText = document.getElementById("modal-status");
            clearInterval(window.downloadingModuleInterval);
            progressBar.style.width = success ? "100%" : "0%";
            statusText.textContent = success ? "Download complete!" : "Download failed.";
            setTimeout(() => { modal.style.display = "none"; }, 500);
            if (success) {
                downloadedModules.add(moduleName);
                localStorage.setItem("downloadedModules", JSON.stringify([...downloadedModules]));
                showNotification(`${moduleName} downloaded successfully!`);
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const fpsSwitchElement = document.getElementById(`fps-switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const checkboxElement = document.getElementById(`fake-device-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const isStopModule = moduleName === "STOP MODULE" || moduleName === "Stop Module";
                if ((switchElement && switchElement.checked) || (fpsSwitchElement && fpsSwitchElement.checked) || (checkboxElement && checkboxElement.checked) || isStopModule) {
                    const fileName = moduleName === "Restore Device" ? "restoredevice.sh" : moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
                    const modulePath = `/storage/emulated/0/Download/com.neon.magisk.module/${fileName}`;
                    let runCommand = `sh ${modulePath}`;
                    if (selectedGames.size > 0 && !isStopModule && moduleName !== "Restore Device") {
                        for (const game of allGames) {
                            if (selectedGames.has(game.game)) {
                                const packageName = game.command.match(/\+([a-zA-Z0-9.]+)/)?.[1] || '';
                                if (packageName) {
                                    runCommand += ` ${packageName}`;
                                }
                            }
                        }
                    }
                    const logId = window.currentLogId || generateRandomId();
                    try {
                        window.Android.executeCommand(runCommand, moduleName, logId);
                    } catch (e) {
                        console.error("Error executing module after download:", e);
                        showNotification("Failed to run module. Ensure Shizuku is running and permissions are granted.");
                        activeModules.delete(moduleName);
                        activeFakeDevices.delete(moduleName);
                        localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                        localStorage.setItem("activeFakeDevices", JSON.stringify([...activeFakeDevices]));
                        window.runComplete(moduleName, false, logId);
                        if (switchElement) switchElement.checked = false;
                        if (fpsSwitchElement) fpsSwitchElement.checked = false;
                        if (checkboxElement) checkboxElement.checked = false;
                    }
                }
            } else {
                showNotification(`Download failed for ${moduleName}. Check your internet connection.`);
                activeModules.delete(moduleName);
                activeFakeDevices.delete(moduleName);
                localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                localStorage.setItem("activeFakeDevices", JSON.stringify([...activeFakeDevices]));
                window.runComplete(moduleName, false, window.currentLogId);
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const fpsSwitchElement = document.getElementById(`fps-switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const checkboxElement = document.getElementById(`fake-device-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (switchElement) switchElement.checked = false;
                if (fpsSwitchElement) fpsSwitchElement.checked = false;
                if (checkboxElement) checkboxElement.checked = false;
            }
        };

        window.runComplete = function(moduleName, success, logId) {
            const finalLogId = logId || window.currentLogId;
            const timestamp = new Date().toLocaleString();
            const fileName = moduleName === "Restore Device" ? "restoredevice.sh" : moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
            const command = selectedGames.size > 0 && !moduleName.includes("STOP MODULE") && !moduleName.includes("Stop Module") && moduleName !== "Restore Device"
                ? `sh /storage/emulated/0/Download/com.neon.magisk.module/${fileName} ${[...selectedGames].map(game => allGames.find(g => g.game === game)?.command.match(/\+([a-zA-Z0-9.]+)/)?.[1] || '').join(' ')}`
                : `sh /storage/emulated/0/Download/com.neon.magisk.module/${fileName}`;
            commandLogs.push({
                command: command.trim(),
                output: window.currentOutput,
                timestamp,
                logId: finalLogId
            });
            localStorage.setItem("commandLogs", JSON.stringify(commandLogs));
            renderLogs();
            if (success) {
                showNotification(`${moduleName} executed successfully!`);
                // Check if URL can be opened
                const lastOpened = sessionStorage.getItem('lastUrlOpenTime');
                const currentTime = Date.now();
                const oneMinute = 30 * 1000; // 1 minute in milliseconds
                if (!lastOpened || (currentTime - parseInt(lastOpened)) > oneMinute) {
                    window.open('https://obqj2.com/4/9587058', '_blank');
                    sessionStorage.setItem('lastUrlOpenTime', currentTime.toString());
                }
                if (window.Android?.deleteModuleFile && moduleName !== "STOP MODULE" && moduleName !== "Stop Module" && moduleName !== "Restore Device") {
                    window.Android.deleteModuleFile(fileName);
                    downloadedModules.delete(moduleName);
                    localStorage.setItem("downloadedModules", JSON.stringify([...downloadedModules]));
                }
                if (allFakeDevices.some(device => device.name === moduleName) || moduleName === "Restore Device") {
                    loadDeviceInfo();
                }
            } else {
                showNotification(`Failed to run module ${moduleName}. Check the logs for details.`);
                activeModules.delete(moduleName);
                activeFakeDevices.delete(moduleName);
                localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
                localStorage.setItem("activeFakeDevices", JSON.stringify([...activeFakeDevices]));
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const fpsSwitchElement = document.getElementById(`fps-switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const checkboxElement = document.getElementById(`fake-device-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (switchElement) switchElement.checked = false;
                if (fpsSwitchElement) fpsSwitchElement.checked = false;
                if (checkboxElement) checkboxElement.checked = false;
            }
            loadModules();
            loadFpsModules();
            loadFakeDevices();
            window.currentOutput = "";
            window.currentLogId = null;
            if (moduleName.includes("Custom Module")) {
                document.getElementById("custom-module-input").value = '';
                document.getElementById("custom-module-btn").textContent = "Select";
                document.getElementById("custom-module-btn").className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
            }
        };

        function renderLogs() {
            const logPanels = document.querySelectorAll("#log-list");
            logPanels.forEach(logPanel => {
                logPanel.innerHTML = commandLogs.length === 0 ? `<p class="text-gray-300 text-sm"><i class="fas fa-info-circle mr-2"></i>No logs yet.</p>` : "";
                [...commandLogs].reverse().forEach((log, index) => {
                    const originalIndex = commandLogs.length - 1 - index;
                    const logItem = document.createElement("div");
                    logItem.className = "flex justify-between items-center bg-gray-800/50 border-l-4 border-purple-600 p-2 rounded-lg mb-1";
                    logItem.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-teal-400 text-sm"><i class="fas fa-clock mr-2"></i>${log.timestamp}</span>
                            <p class="text-sm"><i class="fas fa-terminal mr-2"></i><strong>Command:</strong> ${log.command.length > 30 ? log.command.substring(0, 27) + '...' : log.command}</p>
                            <p class="text-sm"><i class="fas fa-id-badge mr-2"></i><strong>Log ID:</strong> ${log.logId || 'N/A'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="text-teal-400 hover:text-teal-300" onclick="viewLog(${originalIndex})"><i class="fas fa-eye"></i></button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteLog(${originalIndex})"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    logPanel.appendChild(logItem);
                });
            });
        }

        async function clearAllLogs() {
            if (await showConfirmation("Are you sure you want to clear all logs?")) {
                if (window.Android?.deleteLog) {
                    for (const log of commandLogs) {
                        window.Android.deleteLog(log.logId);
                    }
                }
                commandLogs = [];
                localStorage.setItem("commandLogs", JSON.stringify(commandLogs));
                renderLogs();
                showNotification("All logs cleared successfully!");
            }
        }

        function viewLog(index) {
            const log = commandLogs[index];
            const modal = document.getElementById("download-modal");
            const modalContent = document.querySelector("#download-modal .modal-content");
            modalContent.innerHTML = `
                <h2 class="text-base font-bold text-teal-300 mb-2"><i class="fas fa-file-alt mr-2"></i>Log Details</h2>
                <p class="text-xs"><i class="fas fa-clock mr-2"></i><strong>Timestamp:</strong> ${log.timestamp}</p>
                <p class="text-xs"><i class="fas fa-terminal mr-2"></i><strong>Command:</strong> ${log.command}</p>
                <p class="text-xs"><i class="fas fa-id-badge mr-2"></i><strong>Log ID:</strong> ${log.logId || 'N/A'}</p>
                <pre class="cmd-output" style="max-height: 30vh; overflow-y: auto; word-wrap: break-word; overflow: hidden; text-overflow: ellipsis;">${parseAnsiColors(log.output)}</pre>
                <button class="px-3 py-1 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400 mt-2 w-full" onclick="document.getElementById('download-modal').style.display='none'">Close</button>
            `;
            modal.style.display = "flex";
        }

        async function deleteLog(index) {
            if (await showConfirmation("Are you sure you want to delete this log?")) {
                const log = commandLogs[index];
                if (window.Android?.deleteLog) window.Android.deleteLog(log.logId);
                commandLogs.splice(index, 1);
                localStorage.setItem("commandLogs", JSON.stringify(commandLogs));
                renderLogs();
                showNotification("Log deleted successfully!");
            }
        }

        function showTab(tabId) {
            const allContents = document.querySelectorAll('.tab-content');
            const allNavItems = document.querySelectorAll('.nav-item');
            
            // Set all tabs to fade out
            allContents.forEach(content => {
                content.style.opacity = '0';
            });

            // Update active nav item
            allNavItems.forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');

            // Show the selected tab with fade-in
            const targetContent = document.getElementById(tabId);
            targetContent.style.display = 'block';
            setTimeout(() => {
                targetContent.classList.add('active');
                targetContent.style.opacity = '1';
            }, 10); // Small delay to ensure display: block is applied before opacity transition

            // Hide other tabs after transition
            setTimeout(() => {
                allContents.forEach(content => {
                    if (content.id !== tabId) {
                        content.style.display = 'none';
                    }
                });
            }, 300); // Match duration-300
        }

        // Sidebar toggle functionality
        document.getElementById("sidebar-toggle").addEventListener("click", () => {
            const sidebar = document.getElementById("sidebar");
            sidebar.classList.toggle("open");
        });

        document.getElementById("sidebar-close").addEventListener("click", () => {
            const sidebar = document.getElementById("sidebar");
            sidebar.classList.remove("open");
        });

        document.getElementById("device-info-toggle").addEventListener("click", () => {
            const content = document.getElementById("device-info");
            content.classList.toggle("show");
            const icon = document.getElementById("device-info-toggle").querySelector(".fa-chevron-down, .fa-chevron-up");
            icon.classList.toggle("fa-chevron-down");
            icon.classList.toggle("fa-chevron-up");
        });

        document.getElementById("refresh-device-info").addEventListener("click", () => {
            loadDeviceInfo();
            showNotification("Device info refreshed!");
        });

        const customModuleInput = document.getElementById("custom-module-input");
        const customModuleBtn = document.getElementById("custom-module-btn");

        customModuleBtn.addEventListener("click", async () => {
            if (customModuleBtn.textContent === "Select") {
                customModuleInput.click();
            } else {
                const shizukuRunning = await checkShizukuStatus();
                if (!shizukuRunning) {
                    showNotification("Shizuku is not running. Please start Shizuku and try again.");
                    customModuleInput.value = '';
                    customModuleBtn.textContent = "Select";
                    customModuleBtn.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                    return;
                }
                handleCustomModule();
            }
        });

        customModuleInput.addEventListener("change", () => {
            if (customModuleInput.files.length) {
                const fileName = customModuleInput.files[0].name;
                const fileExtension = fileName.split('.').pop().toLowerCase();
                if (fileExtension === 'sh') {
                    customModuleBtn.textContent = "Run";
                    customModuleBtn.className = "px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-500";
                } else {
                    showNotification("The selected file is not a .sh script. Please select a .sh file.");
                    customModuleInput.value = '';
                    customModuleBtn.textContent = "Select";
                    customModuleBtn.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                }
            }
        });

        document.getElementById("restore-device-btn").addEventListener("click", async () => {
            if (await showConfirmation("Are you sure you want to restore the device to its original settings?")) {
                handleRestoreDevice();
            }
        });

        document.querySelectorAll("#clear-logs-btn, #clear-logs-btn-performance, #clear-logs-btn-game").forEach(btn => {
            btn.addEventListener("click", clearAllLogs);
        });

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const tabId = item.getAttribute('data-tab');
                showTab(tabId);
                // Close sidebar when a tab is selected
                const sidebar = document.getElementById("sidebar");
                sidebar.classList.remove("open");
            });
        });

        checkShizukuStatus();
        loadModules();
        loadFpsModules();
        loadFakeDevices();
        loadGames();
        loadDeviceInfo();
        loadAppVersion();
        renderLogs();
    </script>
</body>
</html>
