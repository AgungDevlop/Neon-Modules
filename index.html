<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPS Injector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&family=JetBrains+Mono:wght@400;700&display=stylesheet">
    <style>
        body {
            font-family: 'Exo 2', sans-serif;
            background: linear-gradient(135deg, #0a1320 0%, #1a2c3a 100%) fixed;
            color: #d4f1f9;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-particles {
            position: absolute;
            inset: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><circle cx="50" cy="50" r="2" fill="#26a69a"/><circle cx="750" cy="750" r="3" fill="#5e35b1"/></svg>') repeat;
            opacity: 0.15;
            z-index: 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #374151;
            transition: background-color 0.3s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: #d4f1f9;
            transition: transform 0.3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #26a69a;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        input:disabled + .slider {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .modal, .confirmation-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow: auto;
        }
        .modal-content, .confirmation-content {
            background: #0a1320;
            border: 1px solid #5e35b1;
            border-radius: 8px;
            padding: 12px;
            width: 90%;
            max-width: 360px;
            max-height: 70vh;
            overflow-y: auto;
            box-sizing: border-box;
            position: relative;
        }
        .confirmation-content {
            max-width: 300px;
            text-align: center;
        }

        .notification {
            display: none;
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #26a69a;
            color: #0a1320;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1001;
            max-width: 90%;
            word-wrap: break-word;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(to right, #26a69a, #5e35b1);
            border-radius: 4px;
            transition: width 0.3s ease-in-out;
            width: 100%;
        }

        .cmd-output {
            background: #0a1320;
            padding: 12px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid #26a69a;
            box-sizing: border-box;
        }

        .ansi-green { color: #26a69a; }
        .ansi-red { color: #ef5350; }
        .ansi-cyan { color: #00acc1; }
        .ansi-yellow { color: #ffca28; }

        .dropdown-content {
            display: none;
            margin-top: 8px;
        }
        .dropdown-content.show {
            display: block;
        }

        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.open {
            transform: translateX(0);
        }

        @media (max-width: 640px) {
            .modal-content, .confirmation-content {
                width: 95%;
                max-width: 95%;
                padding: 10px;
            }
            .cmd-output {
                font-size: 11px;
                max-height: 35vh;
            }
            .notification {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div class="bg-particles"></div>
    <div class="container mx-auto max-w-4xl relative z-10">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <button id="sidebar-toggle" class="text-teal-400 hover:text-teal-300 sm:mr-4">
                <i class="fas fa-bars text-lg"></i>
            </button>
            <h1 class="text-2xl sm:text-3xl font-bold text-teal-300">FPS Injector Dashboard</h1>
            <div class="flex items-center mt-4 sm:mt-0">
                <div id="shizuku-status" class="flex items-center gap-2 px-3 py-1 bg-gray-800/50 border border-teal-500 rounded-full text-sm">
                    <i class="fas fa-circle-notch fa-spin" style="color: #6b7280;"></i>
                    <span>Checking Shizuku...</span>
                </div>
            </div>
        </div>
        <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-center cursor-pointer" id="device-info-toggle">
                <h2 class="text-lg font-bold text-teal-300">Device Info</h2>
                <i class="fas fa-chevron-down text-teal-400"></i>
            </div>
            <div id="device-info" class="dropdown-content text-gray-300"></div>
        </div>
        <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
            <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-cog mr-2"></i>Custom Module</h2>
            <div id="custom-module-list">
                <div class="flex justify-between items-center bg-gray-800/50 border-l-4 border-purple-600 p-3 rounded-lg mb-2">
                    <span class="flex items-center gap-2">
                        <i class="fas fa-cog text-teal-400"></i>
                        <span>Using Custom Module</span>
                    </span>
                    <div>
                        <input type="file" id="custom-module-input" accept=".sh" class="hidden">
                        <button id="custom-module-btn" class="px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400">Select</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mb-4">
            <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-cogs mr-2"></i>Modules</h2>
            <div id="module-items"></div>
        </div>
        <div id="cmd-output" class="cmd-output"></div>
        <div class="bg-gray-900/80 border border-teal-500 rounded-lg p-4 mt-4">
            <h2 class="text-lg font-bold text-teal-300 mb-2"><i class="fas fa-history mr-2"></i>Command Log</h2>
            <div id="log-list"></div>
        </div>
    </div>

    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-900/90 border-r border-teal-500 transform -translate-x-full transition-transform duration-300 z-20">
        <div class="p-4">
            <button id="sidebar-close" class="text-teal-400 hover:text-teal-300 mb-4">
                <i class="fas fa-times text-lg"></i>
            </button>
            <h2 class="text-lg font-bold text-teal-300 mb-4"><i class="fas fa-bars mr-2"></i>Menu</h2>
            <ul class="space-y-3">
                <li><a href="#" class="flex items-center gap-2 text-teal-400 hover:text-teal-300"><i class="fas fa-info-circle"></i><span id="app-version">Version: Loading...</span></a></li>
                <li><a href="#" class="flex items-center gap-2 text-teal-400 hover:text-teal-300"><i class="fas fa-star"></i><span>Rating: 4.5/5</span></a></li>
                <li><a href="#" class="flex items-center gap-2 text-teal-400 hover:text-teal-300"><i class="fas fa-user"></i><span>Credit: Agung Developer</span></a></li>
                <li><a href="https://paypal.me/agungdeveloper" class="flex items-center gap-2 text-teal-400 hover:text-teal-300" target="_blank"><i class="fas fa-donate"></i><span>Donate</span></a></li>
            </ul>
        </div>
        <div class="p-4 border-t border-gray-700 text-center">
            <h3 class="text-md font-semibold text-teal-300 mb-2"><i class="fas fa-share-alt mr-2"></i>Follow Us</h3>
            <div class="flex justify-center gap-4 text-teal-400">
                <a href="https://youtube.com/@agungdeveloper" class="hover:text-teal-300 text-xl" target="_blank"><i class="fab fa-youtube"></i></a>
                <a href="https://tiktok.com/@agungdeveloper" class="hover:text-teal-300 text-xl" target="_blank"><i class="fab fa-tiktok"></i></a>
                <a href="https://instagram.com/@agungdeveloper" class="hover:text-teal-300 text-xl" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://agungdeveloper.com" class="hover:text-teal-300 text-xl" target="_blank"><i class="fas fa-globe"></i></a>
            </div>
        </div>
    </div>

    <div id="download-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" class="text-base font-bold text-teal-300 mb-2"><i class="fas fa-download mr-2"></i>Processing...</h2>
            <div class="progress-bar" id="modal-progress" style="width: 0%"></div>
            <p id="modal-status" class="mt-2 text-gray-300 text-xs"></p>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <div id="confirmation-modal" class="confirmation-modal">
        <div class="confirmation-content">
            <p id="confirmation-message" class="text-sm text-teal-200 mb-3"></p>
            <div class="flex justify-center gap-2">
                <button id="confirm-yes" class="px-3 py-1 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400">Yes</button>
                <button id="confirm-no" class="px-3 py-1 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-500">No</button>
            </div>
        </div>
    </div>

    <script>
        let confirmResolver;

        function showConfirmation(message) {
            const modal = document.getElementById("confirmation-modal");
            document.getElementById("confirmation-message").textContent = message;
            modal.style.display = "flex";
            return new Promise(resolve => { confirmResolver = resolve; });
        }

        document.getElementById("confirm-yes").addEventListener("click", () => {
            document.getElementById("confirmation-modal").style.display = "none";
            if (confirmResolver) confirmResolver(true);
        });

        document.getElementById("confirm-no").addEventListener("click", () => {
            document.getElementById("confirmation-modal").style.display = "none";
            if (confirmResolver) confirmResolver(false);
        });

        function showNotification(message, duration = 3000) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.style.display = "block";
            setTimeout(() => { notification.style.display = "none"; }, duration);
        }

        function generateRandomId() {
            const characters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            return Array(15).fill().map(() => characters.charAt(Math.floor(Math.random() * characters.length))).join('');
        }

        function parseAnsiColors(text) {
            const ansiMap = {
                '\x1B[0;31m': '<span class="ansi-red">',
                '\x1B[0;32m': '<span class="ansi-green">',
                '\x1B[0;36m': '<span class="ansi-cyan">',
                '\x1B[1;33m': '<span class="ansi-yellow">',
                '\x1B[0m': '</span>'
            };
            let result = text.replace(/[&<>"']/g, m => ({ '&': '&', '<': '<', '>': '>', '"': '"', "'": '\x27' })[m]);
            for (const [ansi, html] of Object.entries(ansiMap)) {
                result = result.replace(new RegExp(ansi.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&'), 'g'), html);
            }
            return result;
        }

        const MODULES_URL = "https://raw.githubusercontent.com/AgungDevlop/Viral/refs/heads/main/Modules.json";
        const downloadedModules = new Set(JSON.parse(localStorage.getItem("downloadedModules") || "[]"));
        const activeModules = new Set(JSON.parse(localStorage.getItem("activeModules") || "[]"));
        let commandLogs = JSON.parse(localStorage.getItem("commandLogs") || "[]");

        async function loadAppVersion() {
            try {
                const version = window.Android?.getAppVersion ? await window.Android.getAppVersion() : "N/A (WebView)";
                document.getElementById("app-version").textContent = `Version: ${version || 'Unknown'}`;
            } catch (e) {
                console.error("Error loading app version:", e);
                document.getElementById("app-version").textContent = "Version: Error";
            }
        }

        async function checkShizukuStatus() {
            try {
                const status = window.Android?.getShizukuStatus ? await window.Android.getShizukuStatus() : false;
                document.getElementById("shizuku-status").innerHTML = `
                    <i class="fas ${status ? 'fa-check-circle' : 'fa-times-circle'}" style="color: ${status ? '#26a69a' : '#ef5350'};"></i>
                    <span>Shizuku: ${status ? 'Running' : 'Not Running'}</span>`;
                return status;
            } catch (e) {
                console.error("Error checking Shizuku status:", e);
                document.getElementById("shizuku-status").innerHTML = `
                    <i class="fas fa-exclamation-circle" style="color: #ef5350;"></i>
                    <span>Shizuku: Error</span>`;
                return false;
            }
        }

        async function loadDeviceInfo() {
            try {
                if (window.Android?.getDeviceInfo) {
                    const info = await window.Android.getDeviceInfo();
                    const deviceInfo = JSON.parse(info);
                    document.getElementById("device-info").innerHTML = `
                        <p class="text-sm"><strong>Device:</strong> ${deviceInfo.brand || 'Unknown'} ${deviceInfo.model || 'Unknown'}</p>
                        <p class="text-sm"><strong>CPU:</strong> ${deviceInfo.cpu || 'Unknown'}</p>
                        <p class="text-sm"><strong>SDK:</strong> ${deviceInfo.sdk || 'Unknown'}</p>
                        <p class="text-sm"><strong>Build:</strong> ${deviceInfo.build || 'Unknown'}</p>
                        <p class="text-sm"><strong>Root:</strong> ${deviceInfo.root || 'Unknown'}</p>
                    `;
                } else {
                    document.getElementById("device-info").innerHTML = `<p class="text-gray-300 text-sm"><i class="fas fa-info-circle mr-2"></i>Device info not available.</p>`;
                }
            } catch (e) {
                console.error("Error loading device info:", e);
                document.getElementById("device-info").innerHTML = `<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>Failed to load device info.</p>`;
            }
        }

        async function checkModuleExists(moduleName) {
            try {
                if (window.Android?.checkFileExists) {
                    const fileName = moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
                    const exists = await window.Android.checkFileExists(`/storage/emulated/0/Download/com.fps.injector/${fileName}`);
                    if (exists && !downloadedModules.has(moduleName)) {
                        downloadedModules.add(moduleName);
                        localStorage.setItem("downloadedModules", JSON.stringify([...downloadedModules]));
                    } else if (!exists && downloadedModules.has(moduleName)) {
                        downloadedModules.delete(moduleName);
                        localStorage.setItem("downloadedModules", JSON.stringify([...downloadedModules]));
                    }
                    return exists;
                }
                return false;
            } catch (e) {
                console.error("Error checking file existence:", e);
                return false;
            }
        }

        let allModules = [];
        async function loadModules() {
            try {
                if (!allModules.length) {
                    let modules = JSON.parse(localStorage.getItem("cachedModules"));
                    if (!modules) {
                        const response = await fetch(MODULES_URL, { cache: "no-store" });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        modules = await response.json();
                        localStorage.setItem("cachedModules", JSON.stringify(modules));
                    }
                    allModules = modules;
                }
                for (const module of allModules) await checkModuleExists(module.name);
                renderModules(allModules);
            } catch (error) {
                console.error("Error loading modules:", error);
                document.getElementById("module-items").innerHTML = '<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>Failed to load modules. Check your internet connection.</p>';
            }
        }

        function renderModules(modules) {
            const moduleList = document.getElementById("module-items");
            moduleList.innerHTML = "";
            modules.forEach(module => {
                const isActive = activeModules.has(module.name);
                const isDownloaded = downloadedModules.has(module.name);
                const moduleItem = document.createElement("div");
                moduleItem.className = "bg-gray-800/50 border-l-4 border-purple-600 p-3 rounded-lg mb-2";
                if (module.name === "Stop Module") {
                    moduleItem.innerHTML = `
                        <button id="btn-${module.name.replace(/[^a-zA-Z0-9]/g, '')}" 
                                class="w-full px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400 ${isActive ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${isActive ? 'disabled' : ''}
                                onclick="handleModuleAction('${module.name}', '${module.url}')">
                            Stop Module
                        </button>
                    `;
                } else {
                    moduleItem.className += " flex justify-between items-center";
                    moduleItem.innerHTML = `
                        <span class="flex items-center gap-2">
                            <i class="fas fa-microchip text-teal-400"></i>
                            <span>${module.name}</span>
                        </span>
                        <label class="switch">
                            <input type="checkbox" id="switch-${module.name.replace(/[^a-zA-Z0-9]/g, '')}" ${isActive ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    `;
                    moduleList.appendChild(moduleItem);
                    const switchElement = document.getElementById(`switch-${module.name.replace(/[^a-zA-Z0-9]/g, '')}`);
                    if (switchElement) {
                        switchElement.addEventListener("change", async (e) => {
                            if (e.target.checked) {
                                if (activeModules.size > 0) {
                                    showNotification("Only one module can be active at a time. Please disable the active module first.");
                                    e.target.checked = false;
                                    return;
                                }
                                const shizukuRunning = await checkShizukuStatus();
                                if (!shizukuRunning) {
                                    showNotification("Shizuku is not running. Please start Shizuku and try again.");
                                    e.target.checked = false;
                                    return;
                                }
                                handleModuleAction(module.name, module.url);
                            }
                        });
                    }
                }
                moduleList.appendChild(moduleItem);
            });
        }

        async function handleModuleAction(moduleName, moduleUrl) {
            if (activeModules.has(moduleName)) {
                showNotification(`${moduleName} is already active.`);
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (switchElement) switchElement.checked = false;
                return;
            }
            if (!window.Android) {
                showNotification("This feature is only available in the Android application.");
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (switchElement) switchElement.checked = false;
                return;
            }
            const fileName = moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
            const modulePath = `/storage/emulated/0/Download/com.fps.injector/${fileName}`;
            const logId = generateRandomId();
            window.currentLogId = logId;
            window.currentOutput = "";
            document.getElementById("cmd-output").innerHTML = "";
            activeModules.add(moduleName);
            localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
            if (!downloadedModules.has(moduleName)) {
                showDownloadModal(moduleName, moduleUrl);
            } else {
                try {
                    const runCommand = `sh ${modulePath}`;
                    await window.Android.executeCommand(runCommand, moduleName, logId);
                } catch (e) {
                    console.error("Error executing module:", e);
                    showNotification("Failed to run module. Ensure Shizuku is running and permissions are granted.");
                    window.runComplete(moduleName, false, logId);
                    const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                    if (switchElement) switchElement.checked = false;
                }
            }
        }

        async function handleCustomModule() {
            const fileInput = document.getElementById("custom-module-input");
            const file = fileInput.files[0];
            const button = document.getElementById("custom-module-btn");
            if (!file) {
                showNotification("Please select a file to run.");
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension !== 'sh') {
                showNotification("The selected file is not a .sh script. Please select a .sh file.");
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            if (!window.Android) {
                showNotification("This feature is only available in the Android application.");
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            const shizukuRunning = await checkShizukuStatus();
            if (!shizukuRunning) {
                showNotification("Shizuku is not running. Please start Shizuku and try again.");
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            const moduleName = file.name.replace(/\.sh$/, '');
            if (activeModules.has(moduleName)) {
                showNotification("This module is already active.");
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            if (activeModules.size > 0) {
                showNotification("Only one module can be active at a time. Please disable the active module first.");
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                return;
            }
            const logId = generateRandomId();
            window.currentLogId = logId;
            window.currentOutput = "";
            document.getElementById("cmd-output").innerHTML = "";
            activeModules.add(moduleName);
            localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const fileContent = e.target.result;
                    const fileName = moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
                    const filePath = `/storage/emulated/0/Download/com.fps.injector/${fileName}`;
                    if (window.Android?.saveCustomModule) {
                        await window.Android.saveCustomModule(fileContent, filePath);
                        const runCommand = `sh ${filePath}`;
                        try {
                            await window.Android.executeCommand(runCommand, moduleName, logId);
                        } catch (e) {
                            console.error("Error executing custom module:", e);
                            showNotification("Failed to run custom module. Ensure Shizuku is running and permissions are granted.");
                            window.runComplete(moduleName, false, logId);
                            fileInput.value = '';
                            button.textContent = "Select";
                            button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                        }
                    } else {
                        showNotification("Android file save functionality not available.");
                        window.runComplete(moduleName, false, logId);
                        fileInput.value = '';
                        button.textContent = "Select";
                        button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                    }
                };
                reader.readAsText(file);
            } catch (e) {
                console.error("Error processing custom module:", e);
                showNotification("Failed to process custom module.");
                window.runComplete(moduleName, false, logId);
                fileInput.value = '';
                button.textContent = "Select";
                button.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
            }
        }

        function showDownloadModal(moduleName, moduleUrl) {
            const modal = document.getElementById("download-modal");
            const progressBar = document.getElementById("modal-progress");
            const statusText = document.getElementById("modal-status");
            const title = document.getElementById("modal-title");
            title.innerHTML = `<i class="fas fa-download mr-2"></i>Downloading ${moduleName}`;
            statusText.textContent = "Starting download...";
            progressBar.style.width = "0%";
            modal.style.display = "flex";
            let currentProgress = 0;
            const progressInterval = setInterval(() => {
                currentProgress = Math.min(currentProgress + 5, 90);
                progressBar.style.width = `${currentProgress}%`;
                statusText.textContent = `Progress: ${currentProgress}%`;
            }, 300);
            window.downloadingModuleInterval = progressInterval;
            try {
                if (window.Android?.downloadFile) {
                    window.Android.downloadFile(moduleUrl, moduleName);
                } else {
                    showNotification("Download functionality not available in this environment.");
                    modal.style.display = "none";
                    clearInterval(window.downloadingModuleInterval);
                    window.runComplete(moduleName, false, window.currentLogId);
                    const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                    if (switchElement) switchElement.checked = false;
                }
            } catch (e) {
                console.error("Error initiating download:", e);
                showNotification("Failed to start download. Check your internet connection or Android interface.");
                modal.style.display = "none";
                clearInterval(window.downloadingModuleInterval);
                window.runComplete(moduleName, false, window.currentLogId);
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (switchElement) switchElement.checked = false;
            }
        }

        window.onShellOutput = function(moduleName, output, logId) {
            const cmdOutput = document.getElementById("cmd-output");
            window.currentOutput = (window.currentOutput || "") + output + "\n";
            cmdOutput.innerHTML = parseAnsiColors(window.currentOutput);
            cmdOutput.scrollTop = cmdOutput.scrollHeight;
            if (window.Android?.saveLog) {
                window.Android.saveLog(window.currentOutput, logId);
            }
        };

        window.downloadComplete = function(moduleName, success) {
            const modal = document.getElementById("download-modal");
            const progressBar = document.getElementById("modal-progress");
            const statusText = document.getElementById("modal-status");
            clearInterval(window.downloadingModuleInterval);
            progressBar.style.width = success ? "100%" : "0%";
            statusText.textContent = success ? "Download complete!" : "Download failed.";
            setTimeout(() => { modal.style.display = "none"; }, 500);
            if (success) {
                downloadedModules.add(moduleName);
                localStorage.setItem("downloadedModules", JSON.stringify([...downloadedModules]));
                showNotification(`${moduleName} downloaded successfully!`);
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                const isStopModule = moduleName === "Stop Module";
                if ((switchElement && switchElement.checked) || isStopModule) {
                    const fileName = moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
                    const modulePath = `/storage/emulated/0/Download/com.fps.injector/${fileName}`;
                    const runCommand = `sh ${modulePath}`;
                    const logId = window.currentLogId || generateRandomId();
                    try {
                        window.Android.executeCommand(runCommand, moduleName, logId);
                    } catch (e) {
                        console.error("Error executing module after download:", e);
                        showNotification("Failed to run module. Ensure Shizuku is running and permissions are granted.");
                        window.runComplete(moduleName, false, logId);
                        if (switchElement) switchElement.checked = false;
                    }
                }
            } else {
                showNotification(`Download failed for ${moduleName}. Check your internet connection.`);
                window.runComplete(moduleName, false, window.currentLogId);
                const switchElement = document.getElementById(`switch-${moduleName.replace(/[^a-zA-Z0-9]/g, '')}`);
                if (switchElement) switchElement.checked = false;
            }
        };

        window.runComplete = function(moduleName, success, logId) {
            const finalLogId = logId || window.currentLogId;
            const timestamp = new Date().toLocaleString();
            commandLogs.push({
                command: `sh /storage/emulated/0/Download/com.fps.injector/${moduleName.replace(/[^a-zA-Z0-9]/g, '')}.sh`,
                output: window.currentOutput,
                timestamp,
                logId: finalLogId
            });
            localStorage.setItem("commandLogs", JSON.stringify(commandLogs));
            renderLogs();
            if (success) {
                showNotification(`${moduleName} executed successfully!`);
                if (window.Android?.deleteModuleFile && moduleName !== "Stop Module") {
                    const fileName = moduleName.replace(/[^a-zA-Z0-9]/g, '') + ".sh";
                    window.Android.deleteModuleFile(fileName);
                    downloadedModules.delete(moduleName);
                    localStorage.setItem("downloadedModules", JSON.stringify([...downloadedModules]));
                }
            } else {
                showNotification(`Failed to run module ${moduleName}. Check the logs for details.`);
            }
            document.getElementById("cmd-output").scrollIntoView({ behavior: 'smooth', block: 'end' });
            activeModules.delete(moduleName);
            localStorage.setItem("activeModules", JSON.stringify([...activeModules]));
            loadModules();
            window.currentOutput = "";
            window.currentLogId = null;
            if (moduleName.includes("Custom Module")) {
                document.getElementById("custom-module-input").value = '';
                document.getElementById("custom-module-btn").textContent = "Select";
                document.getElementById("custom-module-btn").className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
            }
        };

        function renderLogs() {
            const logPanel = document.getElementById("log-list");
            logPanel.innerHTML = commandLogs.length === 0 ? `<p class="text-gray-300 text-sm"><i class="fas fa-info-circle mr-2"></i>No logs yet.</p>` : "";
            [...commandLogs].reverse().forEach((log, index) => {
                const originalIndex = commandLogs.length - 1 - index;
                const logItem = document.createElement("div");
                logItem.className = "flex justify-between items-center bg-gray-800/50 border-l-4 border-purple-600 p-3 rounded-lg mb-2";
                logItem.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-teal-400 text-sm"><i class="fas fa-clock mr-2"></i>${log.timestamp}</span>
                        <p class="text-sm"><i class="fas fa-terminal mr-2"></i><strong>Command:</strong> ${log.command.length > 30 ? log.command.substring(0, 27) + '...' : log.command}</p>
                        <p class="text-sm"><i class="fas fa-id-badge mr-2"></i><strong>Log ID:</strong> ${log.logId || 'N/A'}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="text-teal-400 hover:text-teal-300" onclick="viewLog(${originalIndex})"><i class="fas fa-eye"></i></button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteLog(${originalIndex})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                logPanel.appendChild(logItem);
            });
        }

        function viewLog(index) {
            const log = commandLogs[index];
            const modal = document.getElementById("download-modal");
            const modalContent = document.getElementById("modal-content");
            modalContent.innerHTML = `
                <h2 class="text-base font-bold text-teal-300 mb-2"><i class="fas fa-file-alt mr-2"></i>Log Details</h2>
                <p class="text-xs"><i class="fas fa-clock mr-2"></i><strong>Timestamp:</strong> ${log.timestamp}</p>
                <p class="text-xs"><i class="fas fa-terminal mr-2"></i><strong>Command:</strong> ${log.command}</p>
                <p class="text-xs"><i class="fas fa-id-badge mr-2"></i><strong>Log ID:</strong> ${log.logId || 'N/A'}</p>
                <pre class="cmd-output" style="max-height: 30vh; overflow-y: auto; word-wrap: break-word; overflow: hidden; text-overflow: ellipsis;">${parseAnsiColors(log.output)}</pre>
                <button class="px-3 py-1 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400 mt-2 w-full" onclick="document.getElementById('download-modal').style.display='none'">Close</button>
            `;
            modal.style.display = "flex";
        }

        async function deleteLog(index) {
            if (await showConfirmation("Are you sure you want to delete this log?")) {
                const log = commandLogs[index];
                if (window.Android?.deleteLog) window.Android.deleteLog(log.logId);
                commandLogs.splice(index, 1);
                localStorage.setItem("commandLogs", JSON.stringify(commandLogs));
                renderLogs();
                showNotification("Log deleted successfully!");
            }
        }

        document.getElementById("device-info-toggle").addEventListener("click", () => {
            const content = document.getElementById("device-info");
            content.classList.toggle("show");
            const icon = document.getElementById("device-info-toggle").querySelector("i");
            icon.classList.toggle("fa-chevron-down");
            icon.classList.toggle("fa-chevron-up");
        });

        const customModuleInput = document.getElementById("custom-module-input");
        const customModuleBtn = document.getElementById("custom-module-btn");

        customModuleBtn.addEventListener("click", async () => {
            if (customModuleBtn.textContent === "Select") {
                customModuleInput.click();
            } else {
                const shizukuRunning = await checkShizukuStatus();
                if (!shizukuRunning) {
                    showNotification("Shizuku is not running. Please start Shizuku and try again.");
                    customModuleInput.value = '';
                    customModuleBtn.textContent = "Select";
                    customModuleBtn.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                    return;
                }
                handleCustomModule();
            }
        });

        customModuleInput.addEventListener("change", () => {
            if (customModuleInput.files.length) {
                const fileName = customModuleInput.files[0].name;
                const fileExtension = fileName.split('.').pop().toLowerCase();
                if (fileExtension === 'sh') {
                    customModuleBtn.textContent = "Run";
                    customModuleBtn.className = "px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-500";
                } else {
                    showNotification("The selected file is not a .sh script. Please select a .sh file.");
                    customModuleInput.value = '';
                    customModuleBtn.textContent = "Select";
                    customModuleBtn.className = "px-4 py-2 bg-teal-500 text-gray-900 rounded-lg font-semibold hover:bg-teal-400";
                }
            }
        });

        document.getElementById("sidebar-toggle").addEventListener("click", () => {
            const sidebar = document.getElementById("sidebar");
            sidebar.classList.toggle("open");
        });

        document.getElementById("sidebar-close").addEventListener("click", () => {
            const sidebar = document.getElementById("sidebar");
            sidebar.classList.remove("open");
        });

        checkShizukuStatus();
        loadModules();
        loadDeviceInfo();
        loadAppVersion();
        renderLogs();
    </script>
</body>
</html>
